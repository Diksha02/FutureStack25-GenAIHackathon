<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaskPilot - Plan Your Day</title>
    <link rel="stylesheet" href="./css/index.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo">
          <span class="logo-icon">üèÜ</span>
          <h1>TaskPilot</h1>
        </div>
        <nav>
          <a href="./index.html" class="active">Plan</a>
          <a href="./today.html">Today</a>
          <a href="./tasks.html">Tasks</a>
          <a href="./focus.html">Focus</a>
          <a href="./settings.html">Settings</a>
        </nav>
      </header>

      <div class="main-content">
        <div class="card input-section">
          <h2>What's on your mind today?</h2>
          <textarea
            id="planInput"
            placeholder="Write your day in plain language...

Example:
Gym at 7, deep work 9‚Äì11, standup at 11:15, groceries after 6, dinner with friends at 8"
          ></textarea>
          <div class="button-group">
            <button class="btn-primary" onclick="generatePlan()">
              <span>Generate AI Plan</span>
            </button>
            <button class="btn-secondary" onclick="clearInput()">
              <span>Clear</span>
            </button>
          </div>
        </div>

        <div class="card">
          <h2>AI Suggestions</h2>
          <div class="loading" id="suggestionsLoading">
            <div class="spinner"></div>
            <p>Generating suggestions...</p>
          </div>
          <div id="suggestionsContent">
            <div class="empty-state">
              <div class="empty-state-icon"></div>
              <p>AI coaching suggestions will appear here</p>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Structured Schedule</h2>
          <div class="loading" id="scheduleLoading">
            <div class="spinner"></div>
            <p>Building your schedule...</p>
          </div>
          <div id="scheduleContent">
            <div class="empty-state">
              <div class="empty-state-icon"></div>
              <p>Your structured schedule will appear here</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentSchedule = [];
      let lastPromptText = "";

      function clearInput() {
        document.getElementById("planInput").value = "";
        document.getElementById("suggestionsContent").innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ü§ñ</div>
                    <p>AI coaching suggestions will appear here</p>
                </div>
            `;
        document.getElementById("scheduleContent").innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <p>Your structured schedule will appear here</p>
                </div>
            `;
      }

      async function generatePlan() {
        const input = document.getElementById("planInput").value.trim();
        lastPromptText = input;

        if (!input) {
          alert("Please write your daily plan first!");
          return;
        }

        // Show loading states
        document.getElementById("suggestionsLoading").classList.add("active");
        document.getElementById("scheduleLoading").classList.add("active");
        document.getElementById("suggestionsContent").innerHTML = "";
        document.getElementById("scheduleContent").innerHTML = "";

        // Simulate API calls (replace with actual API calls)
        setTimeout(() => generateSuggestions(input), 1000);

        try {
          const response = await fetch("/generate-plan", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ dailyPlan: input }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (data.success) {
            displaySchedule(data.aiPlan);
          } else {
            throw new Error(data.error || "Failed to generate AI plan.");
          }
        } catch (error) {
          console.error("Error generating AI plan:", error);
          alert("Failed to generate AI plan. Please try again later.");
          document.getElementById("scheduleLoading").classList.remove("active");
          document.getElementById("scheduleContent").innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
        }
      }

      async function generateSuggestions(input) {
        document.getElementById("suggestionsLoading").classList.add("active");
        document.getElementById("suggestionsContent").innerHTML = "";

        try {
          const response = await fetch("/generate-suggestions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ dailyPlan: input }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (data.success) {
            displaySuggestions(data.suggestions);
          } else {
            throw new Error(data.error || "Failed to generate AI suggestions.");
          }
        } catch (error) {
          console.error("Error generating AI suggestions:", error);
          alert("Failed to generate AI suggestions. Please try again later.");
          document
            .getElementById("suggestionsLoading")
            .classList.remove("active");
          document.getElementById("suggestionsContent").innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
        }
      }

      function displaySuggestions(suggestionsText) {
        document
          .getElementById("suggestionsLoading")
          .classList.remove("active");
        const suggestionsList = suggestionsText
          .split("\n")
          .filter((line) => line.trim() !== "" && line.startsWith("-"));

        if (suggestionsList.length === 0) {
          document.getElementById("suggestionsContent").innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ü§∑‚Äç‚ôÇÔ∏è</div>
                    <p>No suggestions generated. Try a different plan!</p>
                </div>
            `;
          return;
        }

        document.getElementById("suggestionsContent").innerHTML = `
                <ul class="suggestions-list">
                    ${suggestionsList
                      .map((s) => {
                        const iconMatch = s.match(/^(-\s*)(\S+)\s*(.*)/);
                        const icon =
                          iconMatch && iconMatch[2] ? iconMatch[2] : "üí°"; // Default icon
                        const text =
                          iconMatch && iconMatch[3]
                            ? iconMatch[3].trim()
                            : s.replace(/^- /, "").trim();
                        return `
                            <li class="suggestion-item">
                                <span class="suggestion-icon">${icon}</span>
                                <span>${text}</span>
                            </li>
                        `;
                      })
                      .join("")}
                </ul>
            `;
      }

      function displaySchedule(aiPlan) {
        // Display the AI-generated plan directly as markdown/HTML
        document.getElementById("scheduleLoading").classList.remove("active");

        currentSchedule = parseAiPlanToStructuredSchedule(aiPlan); // Populate global currentSchedule

        document.getElementById("scheduleContent").innerHTML = `
                <div class="ai-plan-output">
                    ${parseAiPlanToTable(currentSchedule)}
                </div>
                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn-primary" onclick="saveSchedule()">
                        <span>üíæ</span>
                        <span>Save to Today</span>
                    </button>
                    <button class="btn-secondary" onclick="exportCalendar()">
                        <span>üì•</span>
                        <span>Export .ics</span>
                    </button>
                </div>
            `;
      }

      function parseAiPlanToStructuredSchedule(aiPlanText) {
        const structuredSchedule = [];
        const lines = aiPlanText
          .split("\n")
          .filter((line) => line.trim() !== "" && line.match(/^\d+\./));

        lines.forEach((line) => {
          const match = line.match(/^\d+\.\s*\*\*(.*?)\*\*:\s*(.*)/);
          if (match && match.length >= 3) {
            const timeRange = match[1].trim(); // e.g., "08:00 AM - 09:00 AM"
            const task = match[2].trim();

            let startTimeStr = "";
            let endTimeStr = "";
            let durationMinutes = 0;

            const timeParts = timeRange.split("-");
            if (timeParts.length === 2) {
              startTimeStr = timeParts[0].trim();
              endTimeStr = timeParts[1].trim();

              const parseTime = (time) => {
                const [timeVal, ampm] = time.split(" ");
                let [hours, minutes] = timeVal.split(":").map(Number);
                if (ampm === "PM" && hours < 12) hours += 12;
                if (ampm === "AM" && hours === 12) hours = 0; // Midnight
                return hours * 60 + minutes;
              };

              const startMinutes = parseTime(startTimeStr);
              const endMinutes = parseTime(endTimeStr);

              durationMinutes = endMinutes - startMinutes;
              if (durationMinutes < 0) {
                durationMinutes += 24 * 60; // Handle overnight tasks
              }
            } else if (timeRange.toLowerCase().includes("onwards")) {
              startTimeStr = timeRange.replace(/onwards/i, "").trim();
              durationMinutes = 1 * 60; // Default to 1 hour for 'onwards' tasks
            } else {
              startTimeStr = timeRange;
              durationMinutes = 60; // Default to 1 hour if no range or 'onwards'
            }

            structuredSchedule.push({
              time: startTimeStr,
              task,
              duration: `${durationMinutes} min`,
              durationMinutes,
              priority: "medium",
            }); // Store parsed duration and default priority
          }
        });
        return structuredSchedule;
      }

      function parseAiPlanToTable(structuredSchedule) {
        let tableRows = "";

        structuredSchedule.forEach((item) => {
          tableRows += `
                            <tr>
                                <td>${item.time}</td>
                                <td>${item.task}</td>
                            </tr>
                        `;
        });

        return `
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Task</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;
      }

      async function saveSchedule() {
        if (!currentSchedule || currentSchedule.length === 0) {
          alert("Nothing to save! Please generate a plan first.");
          return;
        }

        // Fallback: capture prompt from textarea if not already set
        if (!lastPromptText || lastPromptText.trim() === "") {
          const inputNode = document.getElementById("planInput");
          if (inputNode) {
            lastPromptText = inputNode.value.trim();
          }
        }

        const today = new Date().toISOString().split("T")[0]; // Format: YYYY-MM-DD
        const planJson = JSON.stringify(currentSchedule); // Convert array of objects to JSON string

        try {
          const response = await fetch("/save-schedule", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              date: today,
              plan: planJson,
              prompt: lastPromptText,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (data.success) {
            alert("‚úÖ Schedule saved to database!");
            setTimeout(() => (window.location.href = "today.html"), 1000);
          } else {
            throw new Error(
              data.error || "Failed to save schedule to database."
            );
          }
        } catch (error) {
          console.error("Error saving schedule:", error);
          alert("Failed to save schedule. Please try again later.");
        }
      }

      function exportCalendar() {
        if (!currentSchedule || currentSchedule.length === 0) {
          alert("No schedule to export. Please generate a plan first.");
          return;
        }

        try {
          // Create iCalendar format
          const now = new Date();
          const today = now.toISOString().split("T")[0].replace(/-/g, "");
          const timestamp =
            now.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";

          let icsContent = [
            "BEGIN:VCALENDAR",
            "VERSION:2.0",
            "PRODID:-//TaskPilot//Schedule Export//EN",
            "CALSCALE:GREGORIAN",
            "METHOD:PUBLISH",
            "X-WR-CALNAME:TaskPilot Schedule",
            "X-WR-TIMEZONE:UTC",
          ];

          // Convert each task to a calendar event
          currentSchedule.forEach((task, index) => {
            const taskTime = task.time || "09:00 AM";
            const taskDuration = task.durationMinutes || 60;

            // Parse time to get start datetime
            const [timeVal, ampm] = taskTime.split(" ");
            let [hours, minutes] = timeVal.split(":").map(Number);
            if (ampm === "PM" && hours < 12) hours += 12;
            if (ampm === "AM" && hours === 12) hours = 0;

            const startDate = new Date(now);
            startDate.setHours(hours, minutes || 0, 0, 0);

            const endDate = new Date(startDate);
            endDate.setMinutes(endDate.getMinutes() + taskDuration);

            // Format dates for iCalendar (YYYYMMDDTHHMMSS)
            const formatDateTime = (date) => {
              const pad = (n) => String(n).padStart(2, "0");
              return (
                date.getFullYear() +
                pad(date.getMonth() + 1) +
                pad(date.getDate()) +
                "T" +
                pad(date.getHours()) +
                pad(date.getMinutes()) +
                pad(date.getSeconds())
              );
            };

            const dtStart = formatDateTime(startDate);
            const dtEnd = formatDateTime(endDate);

            // Clean task description for calendar
            const taskDescription = task.task
              .replace(/\n/g, "\\n")
              .replace(/,/g, "\\,");
            const priority = task.priority || "medium";
            const priorityMap = { high: 1, medium: 5, low: 9 };

            icsContent.push(
              "BEGIN:VEVENT",
              `UID:taskpilot-${today}-${index}@taskpilot.app`,
              `DTSTAMP:${timestamp}`,
              `DTSTART:${dtStart}`,
              `DTEND:${dtEnd}`,
              `SUMMARY:${taskDescription}`,
              `DESCRIPTION:Priority: ${priority}\\nDuration: ${taskDuration} minutes`,
              `PRIORITY:${priorityMap[priority]}`,
              `STATUS:CONFIRMED`,
              `SEQUENCE:0`,
              "END:VEVENT"
            );
          });

          icsContent.push("END:VCALENDAR");

          // Create downloadable file
          const icsBlob = new Blob([icsContent.join("\r\n")], {
            type: "text/calendar;charset=utf-8",
          });

          const downloadLink = document.createElement("a");
          downloadLink.href = URL.createObjectURL(icsBlob);
          downloadLink.download = `taskpilot-schedule-${today}.ics`;

          // Trigger download
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);

          // Clean up
          URL.revokeObjectURL(downloadLink.href);

          alert(
            "‚úÖ Calendar exported! Import the .ics file into Google Calendar, Outlook, or Apple Calendar."
          );
        } catch (error) {
          console.error("Export error:", error);
          alert("‚ùå Failed to export calendar. Please try again.");
        }
      }
    </script>
  </body>
</html>
