<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaskPilot - Plan Your Day</title>
    <link rel="stylesheet" href="./css/index.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo">
          <span class="logo-icon">üèÜ</span>
          <h1>TaskPilot</h1>
        </div>
        <nav>
          <a href="./index.html" class="active">Plan</a>
          <a href="./today.html">Today</a>
          <a href="./tasks.html">Tasks</a>
          <a href="./focus.html">Focus</a>
          <a href="./settings.html">Settings</a>
        </nav>
      </header>

      <div class="main-content">
        <div class="card input-section">
          <h2>What's on your mind today?</h2>
          <textarea
            id="planInput"
            placeholder="Write your day in plain language...

Example:
Gym at 7, deep work 9‚Äì11, standup at 11:15, groceries after 6, dinner with friends at 8"
          ></textarea>
          <div class="button-group">
            <button class="btn-primary" onclick="generatePlan()">
              <span>Generate AI Plan</span>
            </button>
            <button class="btn-secondary" onclick="clearInput()">
              <span>Clear</span>
            </button>
          </div>
        </div>

        <div class="card">
          <h2>üß† AI Coach Analysis</h2>
          <p
            style="
              color: #718096;
              font-size: 14px;
              margin-top: -10px;
              margin-bottom: 15px;
            "
          >
            Smart analysis of your schedule with actionable improvements
          </p>
          <div class="loading" id="suggestionsLoading">
            <div class="spinner"></div>
            <p>AI coach is analyzing your schedule...</p>
          </div>
          <div id="suggestionsContent">
            <div class="empty-state">
              <div class="empty-state-icon">ü§ñ</div>
              <p>
                AI coach will analyze your schedule and provide specific
                suggestions
              </p>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Structured Schedule</h2>

          <!-- Model Selection Banner -->
          <div
            id="modelBanner"
            style="
              display: none;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              padding: 12px 20px;
              border-radius: 8px;
              margin-bottom: 15px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            "
          >
            <div>
              <strong>ü§ñ AI Model:</strong>
              <span id="currentModelName">Loading...</span>
              <span
                style="margin-left: 10px; opacity: 0.9; font-size: 14px"
                id="currentModelQuality"
              ></span>
            </div>
            <button
              onclick="window.location.href='/settings.html'"
              style="
                background: rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 6px 16px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s;
              "
              onmouseover="this.style.background='rgba(255,255,255,0.3)'"
              onmouseout="this.style.background='rgba(255,255,255,0.2)'"
            >
              Change Model ‚öôÔ∏è
            </button>
          </div>

          <div class="loading" id="scheduleLoading">
            <div class="spinner"></div>
            <p>Building your schedule...</p>
          </div>
          <div id="scheduleContent">
            <div class="empty-state">
              <div class="empty-state-icon"></div>
              <p>Your structured schedule will appear here</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentSchedule = [];
      let lastPromptText = "";

      // Load current model info on page load
      async function loadCurrentModel() {
        try {
          const response = await fetch("/api/models");
          const data = await response.json();

          if (data.success && data.models && data.currentModel) {
            const currentModel = data.models.find(
              (m) => m.id === data.currentModel
            );
            if (currentModel) {
              document.getElementById("currentModelName").textContent =
                currentModel.name;
              document.getElementById(
                "currentModelQuality"
              ).textContent = `${currentModel.speed} | ${currentModel.quality}`;
              document.getElementById("modelBanner").style.display = "flex";
            }
          }
        } catch (error) {
          console.error("Failed to load current model:", error);
          // Show banner anyway with default text
          document.getElementById("currentModelName").textContent =
            "Default Model";
          document.getElementById("currentModelQuality").textContent = "";
          document.getElementById("modelBanner").style.display = "flex";
        }
      }

      // Load model info when page loads
      window.addEventListener("DOMContentLoaded", loadCurrentModel);

      function clearInput() {
        document.getElementById("planInput").value = "";
        document.getElementById("suggestionsContent").innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ü§ñ</div>
                    <p>AI coaching suggestions will appear here</p>
                </div>
            `;
        document.getElementById("scheduleContent").innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <p>Your structured schedule will appear here</p>
                </div>
            `;
      }

      async function generatePlan() {
        const input = document.getElementById("planInput").value.trim();
        lastPromptText = input;

        if (!input) {
          alert("Please write your daily plan first!");
          return;
        }

        // Show loading states
        document.getElementById("suggestionsLoading").classList.add("active");
        document.getElementById("scheduleLoading").classList.add("active");
        document.getElementById("suggestionsContent").innerHTML = "";
        document.getElementById("scheduleContent").innerHTML = "";

        try {
          // STEP 1: Generate the schedule first
          const response = await fetch("/generate-plan", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ dailyPlan: input }),
          });

          const data = await response.json();

          if (data.success) {
            displaySchedule(data.aiPlan);

            // Store metrics in localStorage for Settings page
            if (data.metadata) {
              localStorage.setItem(
                "lastGenMetrics",
                JSON.stringify(data.metadata)
              );

              // Update model banner to show it was just used
              const modelResponse = await fetch("/api/models");
              const modelData = await modelResponse.json();
              if (modelData.success) {
                const usedModel = modelData.models.find(
                  (m) => m.id === data.metadata.model
                );
                if (usedModel) {
                  document.getElementById(
                    "currentModelName"
                  ).textContent = `${usedModel.name} (Just used - ${data.metadata.latency}ms)`;
                  document.getElementById(
                    "currentModelQuality"
                  ).textContent = `${usedModel.speed} | ${usedModel.quality}`;
                }
              }
            }

            // STEP 2: Now generate schedule-aware suggestions
            // Pass the structured schedule to the coach
            generateSuggestions(input, currentSchedule);
          } else {
            // Handle error from backend
            const isRateLimit = response.status === 429 || data.retryable;
            const errorMessage = data.error || "Failed to generate AI plan.";

            console.error("Error generating AI plan:", errorMessage);
            document
              .getElementById("scheduleLoading")
              .classList.remove("active");
            document
              .getElementById("suggestionsLoading")
              .classList.remove("active");

            if (isRateLimit) {
              // Show rate limit message with retry button
              document.getElementById("scheduleContent").innerHTML = `
                <div class="empty-state">
                  <div class="empty-state-icon">‚è≥</div>
                  <p style="color: #e67e22; font-weight: 500;">${errorMessage}</p>
                  <p style="color: #718096; font-size: 14px; margin-top: 10px;">
                    Cerebras is experiencing high traffic. The system will automatically retry.
                  </p>
                  <button onclick="generatePlan()" 
                          style="margin-top: 15px; padding: 10px 20px; background: #5568d3; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                    üîÑ Retry Now
                  </button>
                </div>
              `;
            } else {
              // Show generic error
              document.getElementById("scheduleContent").innerHTML = `
                <div class="empty-state">
                  <div class="empty-state-icon">‚ùå</div>
                  <p>Error: ${errorMessage}</p>
                </div>
              `;
            }
          }
        } catch (error) {
          console.error("Error generating AI plan:", error);
          document.getElementById("scheduleLoading").classList.remove("active");
          document
            .getElementById("suggestionsLoading")
            .classList.remove("active");
          document.getElementById("scheduleContent").innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>Network error. Please check your connection and try again.</p>
                    </div>
                `;
        }
      }

      async function generateSuggestions(input, schedule = null) {
        document.getElementById("suggestionsLoading").classList.add("active");
        document.getElementById("suggestionsContent").innerHTML = "";

        try {
          const response = await fetch("/generate-suggestions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              dailyPlan: input,
              schedule: schedule, // Pass the schedule for analysis
            }),
          });

          const data = await response.json();

          if (data.success) {
            displaySuggestions(data.suggestions);
          } else {
            // Handle error with user-friendly message
            const isRateLimit = response.status === 429 || data.retryable;
            const errorMessage =
              data.error || "Failed to generate AI suggestions.";

            console.error("Error generating AI suggestions:", errorMessage);

            document
              .getElementById("suggestionsLoading")
              .classList.remove("active");

            if (isRateLimit) {
              // Show rate limit message with retry option
              document.getElementById("suggestionsContent").innerHTML = `
                <div class="empty-state">
                  <div class="empty-state-icon">‚è≥</div>
                  <p style="color: #e67e22; font-weight: 500;">${errorMessage}</p>
                  <button onclick="generateSuggestions('${input.replace(
                    /'/g,
                    "\\'"
                  )}', currentSchedule)" 
                          style="margin-top: 15px; padding: 10px 20px; background: #5568d3; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                    üîÑ Try Again
                  </button>
                </div>
              `;
            } else {
              // Show generic error
              document.getElementById("suggestionsContent").innerHTML = `
                <div class="empty-state">
                  <div class="empty-state-icon">‚ùå</div>
                  <p>Error: ${errorMessage}</p>
                </div>
              `;
            }
          }
        } catch (error) {
          console.error("Error generating AI suggestions:", error);
          document
            .getElementById("suggestionsLoading")
            .classList.remove("active");
          document.getElementById("suggestionsContent").innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>Network error. Please check your connection and try again.</p>
                    </div>
                `;
        }
      }

      function displaySuggestions(suggestionsText) {
        document
          .getElementById("suggestionsLoading")
          .classList.remove("active");

        // Parse structured coaching format with sections
        const sections = [];
        const lines = suggestionsText.split("\n");
        let currentSection = null;

        lines.forEach((line) => {
          const trimmed = line.trim();

          // Check if line is a section header (with or without bold markers)
          if (trimmed.match(/^(\*\*)?[‚úÖ‚ö†Ô∏èüí°üß†]/)) {
            // Save previous section
            if (currentSection) {
              sections.push(currentSection);
            }
            // Start new section - remove bold markers and trailing colons
            const headerText = trimmed
              .replace(/^\*\*/, "")
              .replace(/\*\*:?$/, "")
              .replace(/:$/, "")
              .trim();
            currentSection = {
              header: headerText,
              items: [],
            };
          }
          // Check if line is a bullet point (may have emoji at start after *)
          else if (
            trimmed.startsWith("*") &&
            trimmed.length > 1 &&
            currentSection
          ) {
            // Remove the leading * and optional emoji, then trim
            let itemText = trimmed.replace(/^\*\s*/, "");
            // Remove leading emoji if present (any emoji character)
            itemText = itemText.replace(/^[\u{1F000}-\u{1F9FF}]\s*/u, "");
            if (itemText) {
              currentSection.items.push(itemText);
            }
          }
        });

        // Add last section
        if (currentSection) {
          sections.push(currentSection);
        }

        // If we found structured sections, display them nicely
        if (sections.length > 0) {
          const html = `
            <div class="coach-analysis">
              ${sections
                .map((section) => {
                  // Determine section color based on emoji
                  let sectionColor = "#5568d3";
                  let bgColor = "#f0f4ff";

                  if (section.header.includes("‚úÖ")) {
                    sectionColor = "#10b981";
                    bgColor = "#ecfdf5";
                  } else if (section.header.includes("‚ö†Ô∏è")) {
                    sectionColor = "#f59e0b";
                    bgColor = "#fef3c7";
                  } else if (section.header.includes("üí°")) {
                    sectionColor = "#8b5cf6";
                    bgColor = "#f5f3ff";
                  } else if (section.header.includes("üß†")) {
                    sectionColor = "#06b6d4";
                    bgColor = "#ecfeff";
                  }

                  return `
                  <div class="coach-section" style="
                    margin-bottom: 20px;
                    padding: 20px;
                    background: ${bgColor};
                    border-left: 4px solid ${sectionColor};
                    border-radius: 8px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                  ">
                    <h3 style="
                      margin: 0 0 15px 0;
                      font-size: 17px;
                      font-weight: 600;
                      color: ${sectionColor};
                      display: flex;
                      align-items: center;
                      gap: 8px;
                    ">
                      ${section.header}
                    </h3>
                    <ul style="
                      margin: 0;
                      padding-left: 24px;
                      list-style: none;
                    ">
                      ${section.items
                        .map(
                          (item) => `
                        <li style="
                          margin-bottom: 10px;
                          line-height: 1.7;
                          color: #374151;
                          position: relative;
                          padding-left: 8px;
                        ">
                          <span style="
                            position: absolute;
                            left: -16px;
                            top: 8px;
                            width: 6px;
                            height: 6px;
                            background: ${sectionColor};
                            border-radius: 50%;
                          "></span>
                          ${item}
                        </li>
                      `
                        )
                        .join("")}
                    </ul>
                  </div>
                `;
                })
                .join("")}
            </div>
          `;

          document.getElementById("suggestionsContent").innerHTML = html;
        } else {
          // Fallback: Show raw text if parsing fails
          document.getElementById("suggestionsContent").innerHTML = `
            <div style="padding: 20px; background: #f7fafc; border-radius: 8px; white-space: pre-wrap; line-height: 1.6;">
              ${suggestionsText.trim()}
            </div>
          `;
        }
      }

      function displaySchedule(aiPlan) {
        // Display the AI-generated plan directly as markdown/HTML
        document.getElementById("scheduleLoading").classList.remove("active");

        currentSchedule = parseAiPlanToStructuredSchedule(aiPlan); // Populate global currentSchedule

        document.getElementById("scheduleContent").innerHTML = `
                <div class="ai-plan-output">
                    ${parseAiPlanToTable(currentSchedule)}
                </div>
                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn-primary" onclick="saveSchedule()">
                        <span>üíæ</span>
                        <span>Save to Today</span>
                    </button>
                    <button class="btn-secondary" onclick="exportCalendar()">
                        <span>üì•</span>
                        <span>Export .ics</span>
                    </button>
                </div>
            `;
      }

      function parseAiPlanToStructuredSchedule(aiPlanText) {
        const structuredSchedule = [];
        const lines = aiPlanText
          .split("\n")
          .filter((line) => line.trim() !== "" && line.match(/^\d+\./));

        lines.forEach((line) => {
          const match = line.match(/^\d+\.\s*\*\*(.*?)\*\*:\s*(.*)/);
          if (match && match.length >= 3) {
            const timeRange = match[1].trim(); // e.g., "08:00 AM - 09:00 AM"
            const task = match[2].trim();

            let startTimeStr = "";
            let endTimeStr = "";
            let durationMinutes = 0;

            const timeParts = timeRange.split("-");
            if (timeParts.length === 2) {
              startTimeStr = timeParts[0].trim();
              endTimeStr = timeParts[1].trim();

              const parseTime = (time) => {
                const [timeVal, ampm] = time.split(" ");
                let [hours, minutes] = timeVal.split(":").map(Number);
                if (ampm === "PM" && hours < 12) hours += 12;
                if (ampm === "AM" && hours === 12) hours = 0; // Midnight
                return hours * 60 + minutes;
              };

              const startMinutes = parseTime(startTimeStr);
              const endMinutes = parseTime(endTimeStr);

              durationMinutes = endMinutes - startMinutes;
              if (durationMinutes < 0) {
                durationMinutes += 24 * 60; // Handle overnight tasks
              }
            } else if (timeRange.toLowerCase().includes("onwards")) {
              startTimeStr = timeRange.replace(/onwards/i, "").trim();
              durationMinutes = 1 * 60; // Default to 1 hour for 'onwards' tasks
            } else {
              startTimeStr = timeRange;
              durationMinutes = 60; // Default to 1 hour if no range or 'onwards'
            }

            structuredSchedule.push({
              time: startTimeStr,
              task,
              duration: `${durationMinutes} min`,
              durationMinutes,
              priority: "medium",
            }); // Store parsed duration and default priority
          }
        });
        return structuredSchedule;
      }

      function parseAiPlanToTable(structuredSchedule) {
        let tableRows = "";

        structuredSchedule.forEach((item) => {
          tableRows += `
                            <tr>
                                <td>${item.time}</td>
                                <td>${item.task}</td>
                            </tr>
                        `;
        });

        return `
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Task</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;
      }

      async function saveSchedule() {
        if (!currentSchedule || currentSchedule.length === 0) {
          alert("Nothing to save! Please generate a plan first.");
          return;
        }

        // Fallback: capture prompt from textarea if not already set
        if (!lastPromptText || lastPromptText.trim() === "") {
          const inputNode = document.getElementById("planInput");
          if (inputNode) {
            lastPromptText = inputNode.value.trim();
          }
        }

        const today = new Date().toISOString().split("T")[0]; // Format: YYYY-MM-DD
        const planJson = JSON.stringify(currentSchedule); // Convert array of objects to JSON string

        try {
          const response = await fetch("/save-schedule", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              date: today,
              plan: planJson,
              prompt: lastPromptText,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (data.success) {
            alert("‚úÖ Schedule saved to database!");
            setTimeout(() => (window.location.href = "today.html"), 1000);
          } else {
            throw new Error(
              data.error || "Failed to save schedule to database."
            );
          }
        } catch (error) {
          console.error("Error saving schedule:", error);
          alert("Failed to save schedule. Please try again later.");
        }
      }

      function exportCalendar() {
        if (!currentSchedule || currentSchedule.length === 0) {
          alert("No schedule to export. Please generate a plan first.");
          return;
        }

        try {
          // Create iCalendar format
          const now = new Date();
          const today = now.toISOString().split("T")[0].replace(/-/g, "");
          const timestamp =
            now.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";

          let icsContent = [
            "BEGIN:VCALENDAR",
            "VERSION:2.0",
            "PRODID:-//TaskPilot//Schedule Export//EN",
            "CALSCALE:GREGORIAN",
            "METHOD:PUBLISH",
            "X-WR-CALNAME:TaskPilot Schedule",
            "X-WR-TIMEZONE:UTC",
          ];

          // Convert each task to a calendar event
          currentSchedule.forEach((task, index) => {
            const taskTime = task.time || "09:00 AM";
            const taskDuration = task.durationMinutes || 60;

            // Parse time to get start datetime
            const [timeVal, ampm] = taskTime.split(" ");
            let [hours, minutes] = timeVal.split(":").map(Number);
            if (ampm === "PM" && hours < 12) hours += 12;
            if (ampm === "AM" && hours === 12) hours = 0;

            const startDate = new Date(now);
            startDate.setHours(hours, minutes || 0, 0, 0);

            const endDate = new Date(startDate);
            endDate.setMinutes(endDate.getMinutes() + taskDuration);

            // Format dates for iCalendar (YYYYMMDDTHHMMSS)
            const formatDateTime = (date) => {
              const pad = (n) => String(n).padStart(2, "0");
              return (
                date.getFullYear() +
                pad(date.getMonth() + 1) +
                pad(date.getDate()) +
                "T" +
                pad(date.getHours()) +
                pad(date.getMinutes()) +
                pad(date.getSeconds())
              );
            };

            const dtStart = formatDateTime(startDate);
            const dtEnd = formatDateTime(endDate);

            // Clean task description for calendar
            const taskDescription = task.task
              .replace(/\n/g, "\\n")
              .replace(/,/g, "\\,");
            const priority = task.priority || "medium";
            const priorityMap = { high: 1, medium: 5, low: 9 };

            icsContent.push(
              "BEGIN:VEVENT",
              `UID:taskpilot-${today}-${index}@taskpilot.app`,
              `DTSTAMP:${timestamp}`,
              `DTSTART:${dtStart}`,
              `DTEND:${dtEnd}`,
              `SUMMARY:${taskDescription}`,
              `DESCRIPTION:Priority: ${priority}\\nDuration: ${taskDuration} minutes`,
              `PRIORITY:${priorityMap[priority]}`,
              `STATUS:CONFIRMED`,
              `SEQUENCE:0`,
              "END:VEVENT"
            );
          });

          icsContent.push("END:VCALENDAR");

          // Create downloadable file
          const icsBlob = new Blob([icsContent.join("\r\n")], {
            type: "text/calendar;charset=utf-8",
          });

          const downloadLink = document.createElement("a");
          downloadLink.href = URL.createObjectURL(icsBlob);
          downloadLink.download = `taskpilot-schedule-${today}.ics`;

          // Trigger download
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);

          // Clean up
          URL.revokeObjectURL(downloadLink.href);

          alert(
            "‚úÖ Calendar exported! Import the .ics file into Google Calendar, Outlook, or Apple Calendar."
          );
        } catch (error) {
          console.error("Export error:", error);
          alert("‚ùå Failed to export calendar. Please try again.");
        }
      }
    </script>
  </body>
</html>
