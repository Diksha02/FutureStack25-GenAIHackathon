<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaskPilot - Focus Mode</title>
    <link rel="stylesheet" href="./css/focus.css" />
  </head>
  <body>
    <a href="today.html" class="back-btn">‚Üê Back</a>

    <div class="container">
      <div class="focus-card">
        <div class="task-name" id="taskName">Focus Session</div>

        <div class="presets">
          <button class="preset-btn active" onclick="setPreset(25)">
            Pomodoro (25m)
          </button>
          <button class="preset-btn" onclick="setPreset(45)">
            Deep Work (45m)
          </button>
          <button class="preset-btn" onclick="setPreset(15)">
            Quick (15m)
          </button>
        </div>

        <div class="timer-display" id="timerDisplay">25:00</div>
        <div class="timer-label" id="timerLabel">Ready to focus?</div>

        <div class="controls">
          <button class="btn-start" id="startBtn" onclick="toggleTimer()">
            <span>Start</span>
          </button>
          <button class="btn-reset" onclick="resetTimer()">
            <span>Reset</span>
          </button>
        </div>

        <div class="session-info">
          <div class="session-stats">
            <div class="stat-item">
              <div class="stat-value" id="sessionsToday">0</div>
              <div class="stat-label">Sessions Today</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="focusTime">0m</div>
              <div class="stat-label">Focus Time</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="currentStreak">0</div>
              <div class="stat-label">Current Streak</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="notification" id="notification">
      <div class="notification-icon">üéâ</div>
      <div class="notification-text">
        <div class="notification-title">Session Complete!</div>
        <div class="notification-message">Great work! Time for a break.</div>
      </div>
    </div>

    <script>
      let timeLeft = 25 * 60; // seconds
      let totalTime = 25 * 60;
      let timerInterval = null;
      let isRunning = false;
      let isBreak = false;
      let stats = {
        sessionsToday: 0,
        totalFocusTime: 0,
        currentStreak: 0,
      };

      function loadStats() {
        const saved = localStorage.getItem("focusStats");
        if (saved) {
          stats = JSON.parse(saved);
          updateStatsDisplay();
        }

        const focusTask = localStorage.getItem("focusTask");
        if (focusTask) {
          const task = JSON.parse(focusTask);
          document.getElementById("taskName").textContent = task.task;
        }

        // Pull settings (durations, autoBreak)
        const settings = JSON.parse(localStorage.getItem("settings") || "{}");
        if (
          typeof settings.focusDuration === "number" &&
          settings.focusDuration > 0
        ) {
          totalTime = settings.focusDuration * 60;
          timeLeft = totalTime;
        }
      }

      function saveStats() {
        localStorage.setItem("focusStats", JSON.stringify(stats));
      }

      function updateStatsDisplay() {
        document.getElementById("sessionsToday").textContent =
          stats.sessionsToday;
        document.getElementById("focusTime").textContent =
          Math.round(stats.totalFocusTime / 60) + "m";
        document.getElementById("currentStreak").textContent =
          stats.currentStreak;
      }

      function setPreset(minutes) {
        if (isRunning) return;

        document
          .querySelectorAll(".preset-btn")
          .forEach((btn) => btn.classList.remove("active"));
        event.target.classList.add("active");

        totalTime = minutes * 60;
        timeLeft = totalTime;
        updateDisplay();
      }

      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, "0")}:${secs
          .toString()
          .padStart(2, "0")}`;
      }

      function updateDisplay() {
        document.getElementById("timerDisplay").textContent =
          formatTime(timeLeft);
      }

      function toggleTimer() {
        if (isRunning) {
          pauseTimer();
        } else {
          startTimer();
        }
      }

      function startTimer() {
        isRunning = true;
        document.body.classList.add("focus-active");
        document.getElementById("timerDisplay").classList.add("active");
        document.getElementById("timerLabel").textContent = isBreak
          ? "Break Time üòå"
          : "Focus Time! üéØ";

        const startBtn = document.getElementById("startBtn");
        startBtn.innerHTML = "<span>‚è∏</span><span>Pause</span>";
        startBtn.classList.remove("btn-start");
        startBtn.classList.add("btn-pause");

        timerInterval = setInterval(() => {
          timeLeft--;
          updateDisplay();

          if (timeLeft <= 0) {
            completeSession();
          }
        }, 1000);
      }

      function pauseTimer() {
        isRunning = false;
        clearInterval(timerInterval);
        document.body.classList.remove("focus-active");
        document.getElementById("timerDisplay").classList.remove("active");
        document.getElementById("timerLabel").textContent = "Paused";

        const startBtn = document.getElementById("startBtn");
        startBtn.innerHTML = "<span>‚ñ∂Ô∏è</span><span>Resume</span>";
        startBtn.classList.add("btn-start");
        startBtn.classList.remove("btn-pause");
      }

      function resetTimer() {
        pauseTimer();
        timeLeft = totalTime;
        isBreak = false;
        updateDisplay();
        document
          .getElementById("timerDisplay")
          .classList.remove("active", "break");
        document.getElementById("timerLabel").textContent = "Ready to focus?";

        const startBtn = document.getElementById("startBtn");
        startBtn.innerHTML = "<span>‚ñ∂Ô∏è</span><span>Start</span>";
        startBtn.classList.add("btn-start");
        startBtn.classList.remove("btn-pause");
      }

      function completeSession() {
        clearInterval(timerInterval);
        isRunning = false;

        if (!isBreak) {
          // Completed focus session
          stats.sessionsToday++;
          stats.totalFocusTime += totalTime;
          stats.currentStreak++;
          saveStats();
          updateStatsDisplay();

          // Respect settings: notifications, sounds, break duration, auto-start
          const settings = JSON.parse(localStorage.getItem("settings") || "{}");
          const breakMinutes = Number(settings.breakDuration) || 5;
          const allowNotif = settings.notifications !== false;
          const allowSound = settings.sounds !== false;
          const autoBreak = settings.autoBreak === true;

          if (allowNotif) {
            showNotification(
              "Session Complete!",
              `Great work! Time for a ${breakMinutes}-minute break.`
            );
          }
          if (allowSound) {
            playSound();
          }

          // Start break
          isBreak = true;
          totalTime = breakMinutes * 60;
          timeLeft = totalTime;
          document.getElementById("timerDisplay").classList.remove("active");
          document.getElementById("timerDisplay").classList.add("break");
          document.getElementById("timerLabel").textContent = "Break Time! üòå";
          updateDisplay();

          // Auto-start break if enabled
          if (autoBreak) {
            startTimer();
          }
        } else {
          // Completed break
          const settings = JSON.parse(localStorage.getItem("settings") || "{}");
          const allowNotif = settings.notifications !== false;
          const allowSound = settings.sounds !== false;
          if (allowNotif) {
            showNotification(
              "Break Complete!",
              "Ready for another focus session?"
            );
          }
          if (allowSound) {
            playSound();
          }

          isBreak = false;
          totalTime = 25 * 60;
          const focusMinutes = Number(settings.focusDuration);
          if (Number.isFinite(focusMinutes) && focusMinutes > 0) {
            totalTime = focusMinutes * 60;
          }
          timeLeft = totalTime;
          document.getElementById("timerDisplay").classList.remove("break");
          document.getElementById("timerLabel").textContent = "Ready to focus?";
          updateDisplay();
        }

        const startBtn = document.getElementById("startBtn");
        startBtn.innerHTML = "<span>‚ñ∂Ô∏è</span><span>Start</span>";
        startBtn.classList.add("btn-start");
        startBtn.classList.remove("btn-pause");
        document.body.classList.remove("focus-active");
      }

      function showNotification(title, message) {
        const notif = document.getElementById("notification");
        notif.querySelector(".notification-title").textContent = title;
        notif.querySelector(".notification-message").textContent = message;
        notif.classList.add("show");

        setTimeout(() => {
          notif.classList.remove("show");
        }, 5000);

        // Browser notification (also gated by settings)
        const settings = JSON.parse(localStorage.getItem("settings") || "{}");
        if (
          settings.notifications !== false &&
          "Notification" in window &&
          Notification.permission === "granted"
        ) {
          new Notification("TaskPilot - " + title, {
            body: message,
          });
        }
      }

      function playSound() {
        // Simple beep using Web Audio API
        const audioContext = new (window.AudioContext ||
          window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = "sine";

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioContext.currentTime + 0.5
        );

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      }

      // Request notification permission
      if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
      }

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.code === "Space") {
          e.preventDefault();
          toggleTimer();
        } else if (e.code === "KeyR") {
          e.preventDefault();
          resetTimer();
        }
      });

      // Prevent accidental page close
      window.addEventListener("beforeunload", (e) => {
        if (isRunning) {
          e.preventDefault();
          e.returnValue = "";
        }
      });

      loadStats();
      updateDisplay();
    </script>
  </body>
</html>
